<head>
	<script src="http://localhost:43001/socket.io/socket.io.js"></script>
	<script src="js/lib/require.js"></script>
	<style>
	body {
		margin : 0;
	}
	</style>
</head>
<body>
	<canvas id=canvas></canvas>
	<script>
	require.config({
		baseUrl : '/',
		shim: {
			"Engine/Utility/underscore": {
				exports: "_"
			}
		}
	});
	require([
		'Engine/Utility/class',
		'Engine/Utility/time',
		'Engine/Utility/underscore',
		
		'Engine/Game/World',
		'Engine/View/WorldView',
		'Engine/Game/Platform',
		'Engine/Game/Light',
		'Engine/Game/Player',
		'Engine/Game/KeyActionListener'
	],
	function( _class, Time, _, World, WorldView, Platform, Light, Player, KeyActionListener ){
		var socket = io.connect('http://localhost:43001/');
		var name;
		
		//socket.emit('requestLogin', prompt('What is your name ?') );
		socket.emit('requestLogin', "rmxhaha" );
		
		function pingServer( callback ){
			var startTime = new Date();
			socket.emit('ping');
			socket.on('pong', function(){
				var endTime = new Date();
				callback( endTime.getTime() - startTime.getTime() );
			});
		}
		
		
		var delayed_new_player_bin = [];
		var delayed_leaving_player_id = [];
		
		var delayed_new_player_handler = function( bin ){
			delayed_new_player_bin.push(bin);
		};
		
		var delayed_leaving_player_handler = function( id ){
			delayed_leaving_player_id.push(id);
		};
		
		socket.on('new_player', delayed_new_player_handler );
		socket.on('leaving_player', delayed_leaving_player_handler );

		function startGame( basebin )
		{
			var canvas = document.getElementById('canvas');
			var context = canvas.getContext('2d');
			var world = new World;
			var time = new Time;
			var latency = 0;
			var updateRate = 120;
			var updateTimeout = 1000 / updateRate;
			var keyActionListener = new KeyActionListener;
			
			setInterval( function(){
				pingServer( function(L){ latency = L; } );
			}, 2000 );
			
			console.log("R");
			console.log( keyActionListener );
			
			setInterval( function(){
				socket.emit('keyAct', keyActionListener.getKeyAction() );
			}, updateTimeout );
			
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
			
			world.parseBaseBin( basebin );
			socket.removeListener('new_player',delayed_new_player_handler);
			socket.removeListener('leaving_player', delayed_leaving_player_handler );

			// process delayed start game
			function process_new_player(bin){
				var player = new Player( Player.baseConverter.convertToClass( bin ) );
				world.add(player);
			}
		
			function process_leaving_player(id){
				var player = world.getPlayerById(id);
				world.remove(player);
			}

			_.each( delayed_leaving_player_id, function(id){
				process_leaving_player(id);
			});
			
			_.each( delayed_new_player_bin, function(bin){
				process_new_player(bin);
			});

			socket.on('new_player', function( bin ){
				process_new_player(bin);
			});
			
			socket.on('leaving_player', function(id){
				process_leaving_player(id);
			});
			
			socket.on('update', function( bin ){
			
				// catch error caused by racing data
				try {
					world.parseUpdateBin( bin, latency / 1000 );
				}
				catch( err ){
					console.log( err );
				}
			});
			
			
			
			window.w = world;
			
			function loop(){
				WorldView.render( context, world );
				world.update( time.reset() / 1000 );
				
				requestAnimationFrame( loop );
			}
			
			loop();
		}
		
		socket.on('base', function( data ){
			console.log( data );
			name = data.name;
			startGame( data.basebin );
		});
		
	});
	</script>
</body>
